## Kubernetes
(For use when you want to run this in a production environment or want to test creating and destroying servers dynamically).

I recommend using [Lens](https://k8slens.dev/) to do administrative tasks related to the cluster, but it is not strictly speaking required.

### Creating the images
By default, the files run on "internal" docker images, which will need to be generated, which you can do with the following:

#### Control Plane image
``` bash
WorldQLDocker/# docker build -f mammothControlPlane.dockerfile -t worldql-control-plane:local .
```

#### Client Server Image
``` bash
WorldQLDocker/# docker build -f mammothClientServer.dockerfile -t worldql-client-server:local .
```
OR (If you are running a locally built plugin, at which case you need to follow the preparation steps located [Here](./DockerComposeManual.md))
``` bash
WorldQLDocker/# docker build -f mammothClientServer_Manual.dockerfile -t worldql-client-server:local .
```

### Setting up and running the cluster
Start off by applying the base setup file
```bash
WorldQLDocker/# kubectl apply -f Kubernetes/ServerScalable/Setup.yaml
```

Generate values for all of the following:
- Postgres db user name
- Postgres db password (cryptographically secure)
- Postgres db database name

Apply those values to the Kubernetes secrets generated by the setup file (You will need to base64 encode the secrets before putting them in as values, or as specified in the [Kubernetes Secrets Documentation](https://kubernetes.io/docs/concepts/configuration/secret/)).

```bash
WorldQLDocker/# kubectl --namespace=mammoth-deployment-client-scaling edit secrets pgsql-connection-info
```

Also take the time to change any pre-existing values, such as the database hostname that will be passed to the control plane if you are hosting the database separately (__DO NOT__ change any values if you are not prepared to debug hostname resolution issues).

```bash
WorldQLDocker/# kubectl --namespace=mammoth-deployment-client-scaling edit configmap mammoth-client-server-environment
```

If you do not have a dedicated database deployment, attach the database deployment file and add the service hostname to the database secret.
```bash
WorldQLDocker/# kubectl apply -f Kubernetes/ServerScalable/Database.yaml
```

Once the database is running (Either internally, or after the hostname configuration has been set if you are hosting the database externally to the cluster), set up the control plane.
```bash
WorldQLDocker/# kubectl apply -f Kubernetes/ServerScalable/ControlPlane.yaml
```

And finally, once everything is up and running, attach the client server deployment.
```bash
WorldQLDocker/# kubectl apply -f Kubernetes/ServerScalable/ClientServers.yaml
```

Use Kubernetes to see what ports your services actually got assigned, and connect to the ports you received.
```bash
WorldQLDocker/# kubectl --namespace=mammoth-deployment-client-scaling get svc mammoth-client-servers
```

Which should have output similar to this:
```bash
NAME                     TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                           AGE
mammoth-client-servers   NodePort   10.96.44.147   <none>        25565:32667/TCP,25565:32667/UDP   13s
```

In this EXAMPLE, the connection port for the minecraft server is not `25565`, but `32667`.  This means that, when you load up your Minecraft game client, you will need to connect to `{Kubernetes hostname}:32667` instead of `{Kubernetes hostname}:25565`.  In local deployments, your hostname is `localhost` or `127.0.0.1`.

---

## F.A.Q.

### How do I remove the whole stack?  Are you expecting me to delete every resource one at a time?
Deleting the whole stack can be accomplished by either deleting the namespace manually, or by apply removing the setup file.  Either method will delete the namespace, which will remove ALL parts of the deployment.

```bash
WorldQLDocker/# kubectl delete -f Kubernetes/ServerScalable/Setup.yaml
```

### I need to connect to the database.  Can I just use like a web UI or something like that?
This guide doesn't mention it, as it is a debugging file, but there is an additional 2 deployments that you can add to aid in debugging.  One allows for debugging internal pod-level DNS issues, and the other is adminer, which allows you to connect to the Postgres DB, if you are using the internal stack for the database.

```bash
WorldQLDocker/# kubectl apply -f Kubernetes/ServerScalable/Debugging.yaml
```

Once this is applied, you can connect to `http://{Kubernetes hostname}:8080` to log into adminer, which should also, by default, have the correct connect credentials.

## How to I add or remove servers?
All you need to do to add or remove servers is to scale the number of replicas in the service for the client servers, using the command below:

```bash
WorldQLDocker/# kubectl --namespace=mammoth-deployment-client-scaling scale deployment mammoth-client-server --replicas=<However many servers you want>
```

Note that you cannot add more servers than you have resources for, and Kubernetes will refuse to add servers if there are no more resources available.  Backing off the number of servers will kill servers off based on the cluster config, usually by the least loaded and/or newest servers first.  This can result in client disconnections if players were on those servers.
